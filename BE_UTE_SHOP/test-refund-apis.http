### ============================================
### ğŸ’° REFUND & CANCELLATION APIs TEST
### ============================================
### 
### HÆ°á»›ng dáº«n sá»­ dá»¥ng:
### 1. Thay {{userToken}} báº±ng token cá»§a báº¡n (láº¥y tá»« login)
### 2. Thay {{orderId}} báº±ng ID Ä‘Æ¡n hÃ ng Ä‘Ã£ thanh toÃ¡n
### 3. Thay {{transactionId}} báº±ng transaction ID tá»« payment
### 4. Äáº£m báº£o Ä‘Æ¡n hÃ ng Ä‘Ã£ thanh toÃ¡n thÃ nh cÃ´ng (payment_status = 'paid')
###
### LÆ°u Ã½: Vá»›i cháº¿ Ä‘á»™ spending mode cá»§a PayOS, khi há»§y Ä‘Æ¡n hÃ ng Ä‘Ã£ thanh toÃ¡n,
### PayOS sáº½ tá»± Ä‘á»™ng hoÃ n tiá»n vá» tÃ i khoáº£n khÃ¡ch hÃ ng
###
### ============================================

### Variables
@baseUrl = http://localhost:5000/api
@userToken = YOUR_TOKEN_HERE
@orderId = 1
@transactionId = 1
@orderCode = 123456789

### ============================================
### ğŸ” BÆ¯á»šC 1: ÄÄ‚NG NHáº¬P
### ============================================

POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "password123"
}

### â†’ LÆ°u token tá»« response vÃ o {{userToken}}

### ============================================
### ğŸ’° HOÃ€N TIá»€N CHO ÄÆ N HÃ€NG ÄÃƒ THANH TOÃN
### ============================================
### API nÃ y cho phÃ©p hoÃ n tiá»n cho Ä‘Æ¡n hÃ ng Ä‘Ã£ thanh toÃ¡n thÃ nh cÃ´ng
###

POST {{baseUrl}}/payment/refund
Content-Type: application/json
Authorization: Bearer {{userToken}}

{
  "order_id": {{orderId}},
  "amount": 600000,
  "reason": "Há»§y Ä‘Æ¡n hÃ ng theo yÃªu cáº§u khÃ¡ch hÃ ng"
}

###
### âœ… Response thÃ nh cÃ´ng:
### {
###   "success": true,
###   "message": "YÃªu cáº§u hoÃ n tiá»n Ä‘Ã£ Ä‘Æ°á»£c gá»­i thÃ nh cÃ´ng",
###   "data": {
###     "refund_id": 1,
###     "refund_amount": 600000,
###     "transaction_id": 1,
###     "payos_refund_id": "refund_abc123",
###     "status": "processing"
###   }
### }
###
### âŒ Lá»—i:
### - 404: Order khÃ´ng tá»“n táº¡i
### - 400: Order chÆ°a thanh toÃ¡n
### - 400: Order Ä‘Ã£ Ä‘Æ°á»£c refund
### - 400: Sá»‘ tiá»n refund > sá»‘ tiá»n Ä‘Ã£ thanh toÃ¡n
###

### ============================================
### ğŸ’° HOÃ€N TIá»€N TOÃ€N Bá»˜ (KhÃ´ng chá»‰ Ä‘á»‹nh amount)
### ============================================

POST {{baseUrl}}/payment/refund
Content-Type: application/json
Authorization: Bearer {{userToken}}

{
  "order_id": {{orderId}},
  "reason": "HoÃ n tiá»n toÃ n bá»™ Ä‘Æ¡n hÃ ng"
}

###
### â†’ Náº¿u khÃ´ng cÃ³ amount, sáº½ refund toÃ n bá»™ sá»‘ tiá»n Ä‘Ã£ thanh toÃ¡n
###

### ============================================
### ğŸ›’ Há»¦Y ÄÆ N HÃ€NG (Vá»šI AUTO REFUND)
### ============================================
### Khi há»§y Ä‘Æ¡n hÃ ng Ä‘Ã£ thanh toÃ¡n qua PayOS, há»‡ thá»‘ng sáº½ tá»± Ä‘á»™ng refund
### Há»‡ thá»‘ng sáº½:
### 1. Táº¡o refund record trong database
### 2. Gá»i PayOS refund API
### 3. Cáº­p nháº­t transaction status = 'refunded'
### 4. Cáº­p nháº­t order payment_status = 'refunded'
### 5. HoÃ n láº¡i tá»“n kho sáº£n pháº©m
###

POST {{baseUrl}}/orders/{{orderId}}/cancel
Content-Type: application/json
Authorization: Bearer {{userToken}}

{
  "reason": "KhÃ´ng cÃ²n muá»‘n mua ná»¯a"
}

###
### âœ… Response thÃ nh cÃ´ng (náº¿u Ä‘Ã£ thanh toÃ¡n):
### {
###   "success": true,
###   "message": "Há»§y Ä‘Æ¡n hÃ ng thÃ nh cÃ´ng. YÃªu cáº§u hoÃ n tiá»n Ä‘Ã£ Ä‘Æ°á»£c gá»­i.",
###   "data": {
###     "refund": {
###       "refund_id": 1,
###       "payos_refund_id": "refund_abc123",
###       "amount": 600000,
###       "status": "processing"
###     }
###   }
### }
###
### âœ… Response thÃ nh cÃ´ng (náº¿u chÆ°a thanh toÃ¡n):
### {
###   "success": true,
###   "message": "Há»§y Ä‘Æ¡n hÃ ng thÃ nh cÃ´ng"
### }
###
### âŒ Lá»—i:
### - 404: Order khÃ´ng tá»“n táº¡i
### - 403: Order khÃ´ng thuá»™c vá» user
### - 400: Order Ä‘Ã£ Ä‘Æ°á»£c xá»­ lÃ½ (status_id > 2 vÃ  chÆ°a thanh toÃ¡n)
###

### ============================================
### ğŸ”„ Há»¦Y PAYMENT TRANSACTION
### ============================================
### Há»§y payment link chÆ°a thanh toÃ¡n (pending/processing)
###

POST {{baseUrl}}/payment/cancel
Content-Type: application/json
Authorization: Bearer {{userToken}}

{
  "transaction_id": {{transactionId}}
}

###
### âœ… Response thÃ nh cÃ´ng:
### {
###   "success": true,
###   "message": "Há»§y thanh toÃ¡n thÃ nh cÃ´ng",
###   "data": {
###     "transaction_id": 1,
###     "status": "cancelled"
###   }
### }
###
### âŒ Lá»—i:
### - 404: Transaction khÃ´ng tá»“n táº¡i
### - 404: Transaction khÃ´ng thuá»™c vá» user
### - 400: Transaction Ä‘Ã£ completed
###

### ============================================
### ğŸ”„ RETRY PAYMENT - Táº O Láº I PAYMENT LINK
### ============================================
### Táº¡o láº¡i payment link cho Ä‘Æ¡n hÃ ng payment failed hoáº·c cancelled
###

POST {{baseUrl}}/payment/retry
Content-Type: application/json
Authorization: Bearer {{userToken}}

{
  "order_id": {{orderId}}
}

###
### âœ… Response thÃ nh cÃ´ng:
### {
###   "success": true,
###   "message": "Táº¡o payment link thÃ nh cÃ´ng",
###   "data": {
###     "transaction_id": 2,
###     "payment_url": "https://pay.payos.vn/web/...",
###     "qr_code_url": "https://img.vietqr.io/...",
###     "order_code": 1234567890
###   }
### }
###
### âŒ Lá»—i:
### - 404: Order khÃ´ng tá»“n táº¡i
### - 400: Order payment_status lÃ  'paid'
###

### ============================================
### ğŸ“‹ LUá»’NG TEST HOÃ€N CHá»ˆNH: THANH TOÃN â†’ REFUND
### ============================================

### BÆ°á»›c 1: Táº¡o Ä‘Æ¡n hÃ ng
POST {{baseUrl}}/orders
Content-Type: application/json
Authorization: Bearer {{userToken}}

{
  "items": [
    {
      "product_id": 1,
      "quantity": 2
    }
  ],
  "shipping_address": {
    "full_name": "Nguyá»…n VÄƒn A",
    "phone": "0123456789",
    "address": "123 ÄÆ°á»ng ABC",
    "ward": "PhÆ°á»ng 1",
    "district": "Quáº­n 1",
    "city": "TP.HCM"
  },
  "billing_address": {
    "full_name": "Nguyá»…n VÄƒn A",
    "phone": "0123456789",
    "address": "123 ÄÆ°á»ng ABC",
    "ward": "PhÆ°á»ng 1",
    "district": "Quáº­n 1",
    "city": "TP.HCM"
  },
  "payment_method": "payos"
}

### â†’ LÆ°u order_id tá»« response

### BÆ°á»›c 2: Táº¡o payment link
POST {{baseUrl}}/payment/payos/create
Content-Type: application/json
Authorization: Bearer {{userToken}}

{
  "order_id": {{orderId}}
}

### â†’ LÆ°u order_code vÃ  payment_url
### â†’ Má»Ÿ payment_url trong browser Ä‘á»ƒ thanh toÃ¡n

### BÆ°á»›c 3: Thanh toÃ¡n táº¡i PayOS (external)
### â†’ Thanh toÃ¡n thÃ nh cÃ´ng
### â†’ PayOS redirect vá» Return URL

### BÆ°á»›c 4: Kiá»ƒm tra tráº¡ng thÃ¡i thanh toÃ¡n
GET {{baseUrl}}/payment/payos/check/{{orderCode}}
Content-Type: application/json

### â†’ Kiá»ƒm tra status = "completed", payment_status = "paid"

### BÆ°á»›c 5: HoÃ n tiá»n (CÃ³ 2 cÃ¡ch)

### CÃ¡ch 1: Refund thá»§ cÃ´ng qua API refund
POST {{baseUrl}}/payment/refund
Content-Type: application/json
Authorization: Bearer {{userToken}}

{
  "order_id": {{orderId}},
  "reason": "Há»§y Ä‘Æ¡n hÃ ng"
}

### CÃ¡ch 2: Há»§y Ä‘Æ¡n hÃ ng (tá»± Ä‘á»™ng refund)
POST {{baseUrl}}/orders/{{orderId}}/cancel
Content-Type: application/json
Authorization: Bearer {{userToken}}

{
  "reason": "KhÃ´ng cÃ²n muá»‘n mua ná»¯a"
}

### â†’ Há»‡ thá»‘ng tá»± Ä‘á»™ng:
###   - Táº¡o refund record trong payment_refunds table
###   - Gá»i PayOS refund API
###   - Cáº­p nháº­t payment_transactions: status = 'refunded'
###   - Cáº­p nháº­t orders: payment_status = 'refunded'
###   - HoÃ n láº¡i tá»“n kho sáº£n pháº©m (tÄƒng stock_quantity)

### BÆ°á»›c 6: Kiá»ƒm tra refund status
GET {{baseUrl}}/payment/my-payments?status=refunded
Content-Type: application/json
Authorization: Bearer {{userToken}}

### â†’ Xem refund Ä‘Ã£ Ä‘Æ°á»£c xá»­ lÃ½ chÆ°a

### BÆ°á»›c 7: Xem chi tiáº¿t Ä‘Æ¡n hÃ ng Ä‘Ã£ refund
GET {{baseUrl}}/orders/{{orderId}}
Content-Type: application/json
Authorization: Bearer {{userToken}}

### â†’ Kiá»ƒm tra payment_status = "refunded"

### ============================================
### âŒ TEST CÃC TRÆ¯á»œNG Há»¢P Lá»–I
### ============================================

### Test 1: Refund Ä‘Æ¡n hÃ ng chÆ°a thanh toÃ¡n
POST {{baseUrl}}/payment/refund
Content-Type: application/json
Authorization: Bearer {{userToken}}

{
  "order_id": {{orderId}}
}

### â†’ Expected: 400 Bad Request - "Chá»‰ cÃ³ thá»ƒ hoÃ n tiá»n cho Ä‘Æ¡n hÃ ng Ä‘Ã£ thanh toÃ¡n"

### Test 2: Refund Ä‘Æ¡n hÃ ng khÃ´ng tá»“n táº¡i
POST {{baseUrl}}/payment/refund
Content-Type: application/json
Authorization: Bearer {{userToken}}

{
  "order_id": 99999
}

### â†’ Expected: 404 Not Found - "KhÃ´ng tÃ¬m tháº¥y Ä‘Æ¡n hÃ ng"

### Test 3: Refund Ä‘Æ¡n hÃ ng Ä‘Ã£ refund
POST {{baseUrl}}/payment/refund
Content-Type: application/json
Authorization: Bearer {{userToken}}

{
  "order_id": {{orderId}}
}

### â†’ Expected: 400 Bad Request - "ÄÆ¡n hÃ ng Ä‘Ã£ Ä‘Æ°á»£c hoÃ n tiá»n"

### Test 4: Refund vá»›i sá»‘ tiá»n lá»›n hÆ¡n sá»‘ tiá»n Ä‘Ã£ thanh toÃ¡n
POST {{baseUrl}}/payment/refund
Content-Type: application/json
Authorization: Bearer {{userToken}}

{
  "order_id": {{orderId}},
  "amount": 999999999
}

### â†’ Expected: 400 Bad Request - "Sá»‘ tiá»n hoÃ n tráº£ khÃ´ng Ä‘Æ°á»£c lá»›n hÆ¡n sá»‘ tiá»n Ä‘Ã£ thanh toÃ¡n"

### Test 5: Refund khÃ´ng cÃ³ order_id
POST {{baseUrl}}/payment/refund
Content-Type: application/json
Authorization: Bearer {{userToken}}

{
  "reason": "Test"
}

### â†’ Expected: 400 Bad Request - "Order ID lÃ  báº¯t buá»™c"

### Test 6: Há»§y payment transaction khÃ´ng tá»“n táº¡i
POST {{baseUrl}}/payment/cancel
Content-Type: application/json
Authorization: Bearer {{userToken}}

{
  "transaction_id": 99999
}

### â†’ Expected: 404 Not Found - "KhÃ´ng tÃ¬m tháº¥y giao dá»‹ch"

### Test 7: Há»§y payment Ä‘Ã£ completed
POST {{baseUrl}}/payment/cancel
Content-Type: application/json
Authorization: Bearer {{userToken}}

{
  "transaction_id": {{transactionId}}
}

### â†’ Expected: 400 Bad Request - "KhÃ´ng thá»ƒ há»§y giao dá»‹ch vá»›i tráº¡ng thÃ¡i completed"

### Test 8: Há»§y Ä‘Æ¡n hÃ ng khÃ´ng tá»“n táº¡i
POST {{baseUrl}}/orders/99999/cancel
Content-Type: application/json
Authorization: Bearer {{userToken}}

{
  "reason": "Test"
}

### â†’ Expected: 404 Not Found - "KhÃ´ng tÃ¬m tháº¥y Ä‘Æ¡n hÃ ng"

### Test 9: Há»§y Ä‘Æ¡n hÃ ng Ä‘Ã£ Ä‘Æ°á»£c xá»­ lÃ½ (Ä‘Ã£ gá»­i Ä‘i)
POST {{baseUrl}}/orders/{{orderId}}/cancel
Content-Type: application/json
Authorization: Bearer {{userToken}}

{
  "reason": "Test"
}

### â†’ Expected: 400 Bad Request - "KhÃ´ng thá»ƒ há»§y Ä‘Æ¡n hÃ ng Ä‘Ã£ Ä‘Æ°á»£c xá»­ lÃ½"
### (Náº¿u order.status_id > 2 vÃ  payment_status != 'paid')

### Test 10: Retry payment cho Ä‘Æ¡n hÃ ng Ä‘Ã£ paid
POST {{baseUrl}}/payment/retry
Content-Type: application/json
Authorization: Bearer {{userToken}}

{
  "order_id": {{orderId}}
}

### â†’ Expected: 400 Bad Request - "KhÃ´ng thá»ƒ táº¡o láº¡i payment link cho Ä‘Æ¡n hÃ ng vá»›i tráº¡ng thÃ¡i paid"

### ============================================
### ğŸ“Š KIá»‚M TRA TRáº NG THÃI SAU REFUND
### ============================================

### 1. Xem lá»‹ch sá»­ thanh toÃ¡n vá»›i filter refunded
GET {{baseUrl}}/payment/my-payments?status=refunded&page=1&limit=10
Content-Type: application/json
Authorization: Bearer {{userToken}}

### 2. Xem chi tiáº¿t Ä‘Æ¡n hÃ ng Ä‘Ã£ refund
GET {{baseUrl}}/orders/{{orderId}}
Content-Type: application/json
Authorization: Bearer {{userToken}}

### â†’ Kiá»ƒm tra:
###   - payment_status = "refunded"
###   - status_id = 5 (cancelled)
###   - CÃ³ refund record trong database

### 3. Xem táº¥t cáº£ lá»‹ch sá»­ thanh toÃ¡n
GET {{baseUrl}}/payment/my-payments?page=1&limit=10
Content-Type: application/json
Authorization: Bearer {{userToken}}

### ============================================
### ğŸ’¡ LÆ¯U Ã QUAN TRá»ŒNG
### ============================================
###
### 1. Vá»›i cháº¿ Ä‘á»™ spending mode cá»§a PayOS:
###    - Khi há»§y Ä‘Æ¡n hÃ ng Ä‘Ã£ thanh toÃ¡n, PayOS sáº½ tá»± Ä‘á»™ng hoÃ n tiá»n
###    - Thá»i gian hoÃ n tiá»n cÃ³ thá»ƒ máº¥t 1-3 ngÃ y lÃ m viá»‡c
###
### 2. Refund cÃ³ thá»ƒ Ä‘Æ°á»£c thá»±c hiá»‡n theo 2 cÃ¡ch:
###    - Refund thá»§ cÃ´ng qua API /payment/refund
###    - Tá»± Ä‘á»™ng khi há»§y Ä‘Æ¡n hÃ ng qua API /orders/:id/cancel
###
### 3. Sau khi refund:
###    - Transaction status = 'refunded'
###    - Order payment_status = 'refunded'
###    - Order status_id = 5 (cancelled)
###    - Tá»“n kho sáº£n pháº©m Ä‘Æ°á»£c hoÃ n láº¡i
###    - Refund record Ä‘Æ°á»£c lÆ°u vÃ o payment_refunds table
###
### 4. Refund status cÃ³ thá»ƒ lÃ :
###    - pending: Chá» xá»­ lÃ½
###    - processing: Äang xá»­ lÃ½
###    - completed: ÄÃ£ hoÃ n tiá»n thÃ nh cÃ´ng
###    - failed: HoÃ n tiá»n tháº¥t báº¡i
###
###
